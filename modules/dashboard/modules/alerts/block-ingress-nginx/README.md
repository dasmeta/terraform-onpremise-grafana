## terraform module prepares ingress alert rules based on nginx ingress controller k8s prometheus metrics
<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | ~> 1.3 |

## Providers

No providers.

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_nginx_service_alerts"></a> [nginx\_service\_alerts](#module\_nginx\_service\_alerts) | ../block-service | n/a |

## Resources

No resources.

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_alerts"></a> [alerts](#input\_alerts) | Alerts to enable on nginx ingress block widgets, if option set null it generally takes option value from var.defaults | <pre>object({<br/>    latency = optional(object({               # configure nginx ingress latency alerts on all hosts/paths<br/>      enabled        = optional(bool, null)   # whether to have alert on latency<br/>      interval       = optional(string, null) # the time interval used to evaluate/aggregate restart count<br/>      pending_period = optional(string, null) # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      threshold      = optional(number, 2)    # threshold seconds above which it will consider request too slow and will fire alert<br/>      no_data_state  = optional(string, null) # define how to handle if no data for query<br/>      exec_err_state = optional(string, null) # define how to handle if query execution error, if set `null` here it takes  defaults value<br/>      labels         = optional(any, {})      # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      group          = optional(string, null) # grafana alert group name which used for grouping<br/>      metric_filter  = optional(string, "")   # allows to define custom metric filter, for example to exclude some host or path<br/>    }), {})<br/>    failed = optional(object({                   # configure nginx ingress 5xx|499 status code response alert on all hosts/paths<br/>      enabled           = optional(bool, null)   # whether to have alert on failed(5xx|499) request<br/>      interval          = optional(string, null) # the time interval used to evaluate/aggregate restart count<br/>      pending_period    = optional(string, null) # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire)<br/>      threshold_percent = optional(number, null) # threshold min percent to fire the alert if exceeded(this is about non failed requests, so that high values are good), if set `null` here it takes defaults labels<br/>      no_data_state     = optional(string, null) # define how to handle if no data for query<br/>      labels            = optional(any, {})      # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      exec_err_state    = optional(string, null) # define how to handle if query execution error, if set `null` here it takes  defaults value<br/>      group             = optional(string, null) # grafana alert group name which used for grouping<br/>      metric_filter     = optional(string, "")   # allows to define custom metric filter, for example to exclude some host or path<br/>    }), {})<br/>    replicas_no = optional(object({<br/>      enabled        = optional(bool, null)                 # whether to have alert if no any replica available<br/>      pending_period = optional(string, "0s")               # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      labels         = optional(any, { "priority" : "P1" }) # define alert labels to filter in notification policies, this extends with override the defaults labels. we set here P1 priority as if there are no any pods the service is down<br/>      no_data_state  = optional(string, null)               # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      exec_err_state = optional(string, null)               # define how to handle if query execution error, if set `null` here it takes  defaults value<br/>      group          = optional(string, null)               # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    replicas_state = optional(object({<br/>      enabled        = optional(bool, null)   # whether to have alert on Failed/Pending/Unknown status/phase replicas/pods, so that if it already long time there pods on those phase we get notified<br/>      pending_period = optional(string, null) # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      threshold      = optional(number, 1)    # the min count of replicas/pods with Failed/Pending/Unknown status/phase to trigger alert<br/>      no_data_state  = optional(string, null) # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      labels         = optional(any, {})      # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      exec_err_state = optional(string, null) # define how to handle if query execution error, if set `null` here it takes  defaults value<br/>      group          = optional(string, null) # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    restarts = optional(object({              # configure service pod/container restart based alert<br/>      enabled        = optional(bool, null)   # whether the restart based alert is enabled<br/>      interval       = optional(string, null) # the time interval used to evaluate/aggregate restart count, if set `null` here it takes  defaults value<br/>      threshold      = optional(number, 3)    # the count of restarts that it will consider as read line to fire alert if exceeded<br/>      no_data_state  = optional(string, null) # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      labels         = optional(any, {})      # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      exec_err_state = optional(string, null) # define how to handle if query execution error, if set `null` here it takes  defaults value<br/>      group          = optional(string, null) # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    network_in = optional(object({            # to configure network in/out traffic anomaly increase alerting<br/>      enabled        = optional(bool, null)   # wether to create alert on network in/receive anomaly increase/decrease of traffic<br/>      pending_period = optional(string, null) # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      interval       = optional(string, null) # the time interval to use to evaluate/aggregate/rate network avg traffic to compare with previous same interval value, if set `null` here it takes  defaults value<br/>      deviation      = optional(number, null) # the threshold to consider increase/decrease of traffic as anomaly and fire alert (in this case 10 means that the traffic got increased x10 times withing provided interval)<br/>      no_data_state  = optional(string, null) # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      labels         = optional(any, {})      # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      exec_err_state = optional(string, null) # define how to handle if query execution error, if set `null` here it takes  defaults value<br/>      group          = optional(string, null) # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    network_out = optional(object({           # to configure network in/out traffic anomaly increase alerting<br/>      enabled        = optional(bool, null)   # wether to create alert on network out/transmit anomaly increase/decrease of traffic<br/>      pending_period = optional(string, null) # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      interval       = optional(string, null) # the time interval to use to evaluate/aggregate/rate network avg traffic to compare with previous same interval value, if set `null` here it takes  defaults value<br/>      deviation      = optional(number, null) # the threshold to consider increase/decrease of traffic as anomaly and fire alert (in this case 10 means that the traffic got increased x10 times withing provided interval)<br/>      no_data_state  = optional(string, null) # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      labels         = optional(any, {})      # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      exec_err_state = optional(string, null) # define how to handle if query execution error, if set `null` here it takes  defaults value<br/>      group          = optional(string, null) # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    cpu = optional(object({                             # to configure cpu/memory overload based alerting<br/>      enabled            = optional(bool, null)         # whether cpu high load based alerting is enabled<br/>      pending_period     = optional(string, null)       # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      interval           = optional(string, null)       # the time interval to use to evaluate/aggregate/rate network avg traffic to compare with previous same interval value, if set `null` here it takes  defaults value<br/>      threshold_percent  = optional(number, null)       # the read line percent to trigger alert of cpu/memory resource usage exceeded, if set `null` here it takes  defaults threshold_percent value<br/>      threshold_resource = optional(string, "requests") # the read line limit metric to use, allowed values are "limits" or "requests"<br/>      threshold          = optional(number, null)       # the read line limit in number of cores(0.256 means 256m) to calculate threshold_percent against, by default it uses deployment limit for this but in case no limit set this can be used to configure custom limit for alert<br/>      no_data_state      = optional(string, null)       # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      exec_err_state     = optional(string, null)       # define how to handle if query execution error, if set `null` here it takes  defaults value<br/>      labels             = optional(any, {})            # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      annotations        = optional(any, {})            # define alert annotations to filter in notification policies, this extends with override the defaults annotations<br/>      group              = optional(string, null)       # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    memory = optional(object({                          # to configure cpu/memory overload based alerting<br/>      enabled            = optional(bool, null)         # whether cpu high load based alerting is enabled<br/>      pending_period     = optional(string, null)       # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      threshold_percent  = optional(number, null)       # the read line percent to trigger alert of cpu/memory resource usage exceeded, if set `null` here it takes  defaults threshold_percent value<br/>      threshold_resource = optional(string, "requests") # the read line limit metric to use, allowed values are "limits" or "requests"<br/>      threshold          = optional(number, null)       # the read line limit in megabytes to calculate threshold_percent against, by default it uses deployment limit for this but in case no limit set this can be used to configure custom limit for alert<br/>      no_data_state      = optional(string, null)       # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      exec_err_state     = optional(string, null)       # define how to handle if query execution error, if set `null` here it takes  defaults value<br/>      labels             = optional(any, {})            # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      annotations        = optional(any, {})            # define alert annotations to filter in notification policies, this extends with override the defaults annotations<br/>      group              = optional(string, null)       # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>  })</pre> | `{}` | no |
| <a name="input_datasource"></a> [datasource](#input\_datasource) | The grafana datasource id which will be used for alert | `string` | `"prometheus"` | no |
| <a name="input_defaults"></a> [defaults](#input\_defaults) | The general default values to use with alert rules | <pre>object({<br/>    enabled           = optional(bool, true)                     # whether by default block widget alerts are enabled, it allows to disable alert by default and enable for specific widget only<br/>    workload_type     = optional(string, "daemonset")            # the workload type of app setup, can be "daemonset" and "deployment"<br/>    workload_suffix   = optional(string, "")                     # allows to filter workload or pod via {var.name}{var.defaults.workload_suffix} filtration, can be used for example in case we have flagger canary deployment to add "-primary" suffix to filter deployment<br/>    workload_prefix   = optional(string, "nginx-ingress-nginx-") # allows to filter workload or pod via {var.defaults.workload_suffix}{var.name} filtration, can be used for example in case we have a deployment which name differs from container name with custom suffix like in nginx ingress container named "controller" and daemonset named "ingress-nginx-controller"<br/>    labels            = optional(any, { "priority" : "P2" })     # the service level monitoring alarms generally are considered as P2 priority and desired to be sent to slack channel)<br/>    pending_period    = optional(string, "1m")                   # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire)<br/>    interval          = optional(string, "5m")                   # the time interval to use to evaluate/aggregate/rate metric for comparison<br/>    deviation         = optional(number, 10)                     # the deviation threshold to consider increase/decrease of metric as anomaly and fire alert, we use this now for network alert (in this case 10 means that the metric got increased x10 times withing provided interval)<br/>    threshold_percent = optional(number, 99)                     # the min percent threshold to use when triggering alerts on percent based expressions, higher values are good<br/>    no_data_state     = optional(string, "NoData")               # define how to handle if no data for query, by default it will fire alert with no data info<br/>    exec_err_state    = optional(string, "Error")                # define how to handle if query execution error, by default it will fire alert with error info<br/>    group             = optional(string, "1. nginx ingress")     # grafana alert group name which used for grouping<br/>    metric_filter     = optional(string, " ")                    # allows to define custom metric filter, for example to exclude some host or path, we specially set `" "` as default value to not get coalesce() function failures<br/>  })</pre> | `{}` | no |
| <a name="input_name"></a> [name](#input\_name) | The name of k8s deployment/service/app/container | `string` | `"controller"` | no |
| <a name="input_namespace"></a> [namespace](#input\_namespace) | The namespace of k8s service/app/container | `string` | `"ingress-nginx"` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_alert_rules"></a> [alert\_rules](#output\_alert\_rules) | The generated alert rules |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
