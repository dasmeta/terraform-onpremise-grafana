## terraform module prepares service/pod/container alert rules based on k8s prometheus metrics
<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.3.0 |

## Providers

No providers.

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_defaults_deep"></a> [defaults\_deep](#module\_defaults\_deep) | cloudposse/config/yaml//modules/deepmerge | 1.0.2 |

## Resources

No resources.

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_alerts"></a> [alerts](#input\_alerts) | Alerts to enable on services/apps which have pods, if option set null it generally takes option value from var.defaults | <pre>object({<br/>    replicas_no = optional(object({<br/>      enabled        = optional(bool, null)                 # whether to have alert if no any replica/pod available<br/>      pending_period = optional(string, "0s")               # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      labels         = optional(any, { "priority" : "P1" }) # define alert labels to filter in notification policies, this extends with override the defaults labels. we set here P1 priority as if there are no any pods the service is down<br/>      no_data_state  = optional(string, null)               # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      group          = optional(string, null)               # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    replicas_min = optional(object({<br/>      enabled        = optional(bool, null)   # whether to have alert on min replicas/pods, so that if there are no at least min count of pods/replicas it will trigger alert<br/>      pending_period = optional(string, null) # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      threshold      = optional(number, null) # for manually set min replica count, if not specified it will automatically get this based on hpa min, recommended to not set this if hpa is enabled, but if prometheus horizontalpodautoscaler metrics are not enable there may be need to set this manually<br/>      no_data_state  = optional(string, null) # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      labels         = optional(any, {})      # define alert labels to filter in notification policies, if set `null` here it takes defaults labels.<br/>      group          = optional(string, null) # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    replicas_max = optional(object({<br/>      enabled        = optional(bool, null)   # whether to have alert on max replicas/pods, so that if it reached to max count of pods/replicas it will trigger alert<br/>      pending_period = optional(string, null) # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      threshold      = optional(number, null) # for manually set max replica count, if not specified it will automatically get this based on hpa min, recommended to not set this if hpa is enabled, but if prometheus horizontalpodautoscaler metrics are not enable there may be need to set this manually<br/>      no_data_state  = optional(string, null) # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      labels         = optional(any, {})      # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      group          = optional(string, null) # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    replicas_state = optional(object({<br/>      enabled        = optional(bool, null)   # whether to have alert on Failed/Pending/Unknown status/phase replicas/pods, so that if it already long time there pods on those phase we get notified<br/>      pending_period = optional(string, null) # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      threshold      = optional(number, 1)    # the min count of replicas/pods with Failed/Pending/Unknown status/phase to trigger alert<br/>      no_data_state  = optional(string, null) # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      labels         = optional(any, {})      # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      group          = optional(string, null) # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    job_failed = optional(object({<br/>      enabled        = optional(bool, false)  # whether to have alert on job/cronjob failed status, we have this alert disabled by default as it is only job/cronjob related<br/>      pending_period = optional(string, null) # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      threshold      = optional(number, 1)    # the min count of failed jobs to trigger alert<br/>      no_data_state  = optional(string, null) # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      labels         = optional(any, {})      # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      group          = optional(string, null) # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    restarts = optional(object({             # configure service pod/container restart based alert<br/>      enabled       = optional(bool, null)   # whether the restart based alert is enabled<br/>      interval      = optional(string, null) # the time interval used to evaluate/aggregate restart count, if set `null` here it takes  defaults value<br/>      threshold     = optional(number, 3)    # the count of restarts that it will consider as read line to fire alert if exceeded<br/>      no_data_state = optional(string, null) # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      labels        = optional(any, {})      # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      group         = optional(string, null) # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    network_in = optional(object({            # to configure network in/out traffic anomaly increase alerting<br/>      enabled        = optional(bool, null)   # wether to create alert on network in/receive anomaly increase/decrease of traffic<br/>      pending_period = optional(string, null) # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      interval       = optional(string, null) # the time interval to use to evaluate/aggregate/rate network avg traffic to compare with previous same interval value, if set `null` here it takes  defaults value<br/>      deviation      = optional(number, null) # the threshold to consider increase/decrease of traffic as anomaly and fire alert (in this case 10 means that the traffic got increased x10 times withing provided interval)<br/>      no_data_state  = optional(string, null) # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      labels         = optional(any, {})      # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      group          = optional(string, null) # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    network_out = optional(object({           # to configure network in/out traffic anomaly increase alerting<br/>      enabled        = optional(bool, null)   # wether to create alert on network out/transmit anomaly increase/decrease of traffic<br/>      pending_period = optional(string, null) # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      interval       = optional(string, null) # the time interval to use to evaluate/aggregate/rate network avg traffic to compare with previous same interval value, if set `null` here it takes  defaults value<br/>      deviation      = optional(number, null) # the threshold to consider increase/decrease of traffic as anomaly and fire alert (in this case 10 means that the traffic got increased x10 times withing provided interval)<br/>      no_data_state  = optional(string, null) # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      labels         = optional(any, {})      # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      group          = optional(string, null) # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    cpu = optional(object({                           # to configure cpu/memory overload based alerting<br/>      enabled            = optional(bool, null)       # whether cpu high load based alerting is enabled<br/>      pending_period     = optional(string, null)     # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      interval           = optional(string, null)     # the time interval to use to evaluate/aggregate/rate network avg traffic to compare with previous same interval value, if set `null` here it takes  defaults value<br/>      threshold_percent  = optional(number, null)     # the read line percent to trigger alert of cpu/memory resource usage exceeded, if set `null` here it takes  defaults threshold_percent value<br/>      threshold_resource = optional(string, "limits") # the read line limit metric to use, allowed values are "limits" or "requests"<br/>      threshold          = optional(number, null)     # the read line limit in number of cores(0.256 means 256m) to calculate threshold_percent against, by default it uses deployment limit for this but in case no limit set this can be used to configure custom limit for alert<br/>      no_data_state      = optional(string, null)     # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      labels             = optional(any, {})          # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      group              = optional(string, null)     # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>    memory = optional(object({                        # to configure cpu/memory overload based alerting<br/>      enabled            = optional(bool, null)       # whether cpu high load based alerting is enabled<br/>      pending_period     = optional(string, null)     # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire), if set `null` here it takes  defaults value<br/>      threshold_percent  = optional(number, null)     # the read line percent to trigger alert of cpu/memory resource usage exceeded, if set `null` here it takes  defaults threshold_percent value<br/>      threshold_resource = optional(string, "limits") # the read line limit metric to use, allowed values are "limits" or "requests"<br/>      threshold          = optional(number, null)     # the read line limit in megabytes to calculate threshold_percent against, by default it uses deployment limit for this but in case no limit set this can be used to configure custom limit for alert<br/>      no_data_state      = optional(string, null)     # define how to handle if no data for query, if set `null` here it takes  defaults value<br/>      labels             = optional(any, {})          # define alert labels to filter in notification policies, this extends with override the defaults labels<br/>      group              = optional(string, null)     # grafana alert group name which used for grouping, if set `null` here it takes  defaults value<br/>    }), {})<br/>  })</pre> | `{}` | no |
| <a name="input_datasource"></a> [datasource](#input\_datasource) | The grafana datasource id which will be used for alert | `string` | `"prometheus"` | no |
| <a name="input_defaults"></a> [defaults](#input\_defaults) | The general default values to use with alert rules | <pre>object({<br/>    enabled           = optional(bool, true)                 # whether by default block widget alerts are enabled, it allows to disable alert by default and enable for specific widget only<br/>    workload_type     = optional(string, "deployment")       # the workload type of app setup, can be "daemonset", "deployment", "statefulset" and "cronjob"<br/>    workload_suffix   = optional(string, "")                 # allows to filter workload or pod via {var.name}{var.defaults.workload_suffix} filtration, can be used for example in case we have flagger canary deployment to add "-primary" suffix to filter deployment<br/>    workload_prefix   = optional(string, "")                 # allows to filter workload or pod via {var.defaults.workload_suffix}{var.name} filtration, can be used for example in case we have a deployment which name differs from container name with custom suffix like in nginx ingress container named "controller" and daemonset named "ingress-nginx-controller"<br/>    labels            = optional(any, { "priority" : "P2" }) # the service level monitoring alarms generally are considered as P2 priority and desired to be sent to slack channel)<br/>    pending_period    = optional(string, "1m")               # define for how long to wait to trigger alert if condition satisfied(how long should satisfied state last to fire)<br/>    interval          = optional(string, "5m")               # the time interval to use to evaluate/aggregate/rate metric for comparison<br/>    deviation         = optional(number, 10)                 # the deviation threshold to consider increase/decrease of metric as anomaly and fire alert, we use this now for network alert (in this case 10 means that the metric got increased x10 times withing provided interval)<br/>    threshold_percent = optional(number, 99)                 # the percent threshold to use when triggering alerts on resources like cpu/memory<br/>    no_data_state     = optional(string, "NoData")           # define how to handle if no data for query, by default it will fire alert with no data info<br/>    group             = optional(string, null)               # grafana alert group name which used for grouping, if null the group name will be based on service name/namespace in format `Service {namespace}/{name}`<br/>  })</pre> | `{}` | no |
| <a name="input_name"></a> [name](#input\_name) | The name of k8s deployment/service/app/container | `string` | n/a | yes |
| <a name="input_namespace"></a> [namespace](#input\_namespace) | The namespace of k8s service/app/container | `string` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_alert_rules"></a> [alert\_rules](#output\_alert\_rules) | The generated alert rules |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
